name: Build and Deploy Trove

on:
  push:
    branches:
      - '**'

env:
  PROJECT_NAME: 'Trove Server'
  IMAGE_NAME: 'trove-server'
  REGISTRY: 'registry.runicrealms.com'
  REGISTRY_PROJECT: 'build'

jobs:
  build-server:
    runs-on: rr-runner
    container:
      image: registry.runicrealms.com/agents/agent-go-protoc:latest
      credentials:
        username: ${{ secrets.HARBOR_USERNAME }}
        password: ${{ secrets.HARBOR_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine Environment
        id: env
        uses: Runic-Studios/Realm-Actions/determine-env@main

      - name: Build Server
        run: |
          cd server
          export PATH="$PATH:/root/go/bin:$(go env GOPATH)/bin"
          ./gen-proto.sh
          go mod download
          go build -buildvcs=false -o trove-server ./cmd

      - name: Get Short SHA
        id: vars
        run: echo "sha_short=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Build and Push Docker Image
        uses: Runic-Studios/Realm-Actions/docker-build-push@main
        with:
          dockerfile: 'trove-server.Dockerfile'
          image_name: ${{ env.IMAGE_NAME }}
          tag: ${{ steps.vars.outputs.sha_short }}
          registry: ${{ env.REGISTRY }}
          registry_project: ${{ env.REGISTRY_PROJECT }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}
          context: '.'

      - name: Update Realm-Deployment
        uses: Runic-Studios/Realm-Actions/update-manifest@main
        with:
          repository: 'Realm-Deployment'
          branch: 'dev'
          file_path: 'values.yaml'
          yq_path: '.trove.server.tag'
          new_value: ${{ steps.vars.outputs.sha_short }}
          ssh_key: ${{ secrets.BOT_SSH_KEY }}
          commit_message: 'Update ${{ env.IMAGE_NAME }} tag to ${{ steps.vars.outputs.sha_short }}'

      - name: Create PR (Main Only)
        if: steps.env.outputs.run_main_deploy == 'true'
        uses: Runic-Studios/Realm-Actions/create-pr@main
        with:
          repository: 'Realm-Deployment'
          base: 'main'
          head: 'dev'
          title: 'AUTOGENERATED: Promote latest Trove image to production'
          body: 'Promoting Trove from dev to main.'
          gh_token: ${{ secrets.BOT_PAT }}
          ssh_key: ${{ secrets.BOT_SSH_KEY }}

  build-client:
    needs: build-server
    runs-on: rr-runner
    container:
      image: registry.runicrealms.com/agents/agent-java-21:latest
      credentials:
        username: ${{ secrets.HARBOR_USERNAME }}
        password: ${{ secrets.HARBOR_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build and Publish Client
        env:
          REPOSILITE_USERNAME: ${{ secrets.REPOSILITE_USERNAME }}
          REPOSILITE_PASSWORD: ${{ secrets.REPOSILITE_PASSWORD }}
        run: |
           cd client
           ./gradlew clean build --no-daemon
           ./gradlew publish
